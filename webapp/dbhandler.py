from pymongo import MongoClient
from settings import DATABASE_NAME as __dbname__
from settings import COLLECTION_NAME as __collection__
import copy


def connect_to_mongodb(__dbname__, __collection__):
    try:
        connection = MongoClient('localhost', 27017)
        db = connection[__dbname__]
        collection = db[__collection__]
        return collection
    except Exception as e:
        print("Unable to establish connection to MongoDB reason = %s" % e)


class MongoHandler(object):
    def __init__(self):
        self.col_obj = connect_to_mongodb(__dbname__, __collection__)

    def get_data(self, full_name):
        output_obj = self.col_obj.find({"full_name": full_name})
        try:
            doc = output_obj.next()
        except Exception as e:
            print(e)
            return {}
        if doc:
            return doc['commit_ids']
        else:
            return {}

    def update_data(self, full_name, sha, vul_cnt):
        output_obj = self.col_obj.find({"full_name": full_name})
        try:
            old_data = output_obj.next()
        except Exception as e:
            print(e)
            old_data = None
        # print "olddata = ", old_data
        if old_data:
            old_data['commit_ids'][sha] = {'vul_cnt': vul_cnt}
            new_data = copy.copy(old_data)
            new_data.pop('_id')
            self.col_obj.update({"_id": old_data['_id']}, new_data, upsert=True)
        else:
            new_data = {
                    "full_name": full_name,
                    "commit_ids": {sha:  {"vul_cnt": vul_cnt}}
                }
            self.col_obj.insert(new_data)

if __name__ == '__main__':
    full_name = 'naman-kumar/TestComment'
    sha = 'aaaaaa721616020946e9bdd7f6e56ea8a76a0dcd8berd'
    vul_cnt = 15
    MH = MongoHandler()
    MH.update_data(full_name, sha, vul_cnt)
    #print MH.get_data(full_name)