import json
import tornado.ioloop
import tornado.web
from gitapi import Githandler


class MainHandler(tornado.web.RequestHandler):
    def get(self):
        self.write("Hello, world")

    def post(self):
        print(self.request.body)
        # todo: clone or pull repo
        json_body = json.loads(self.request.body)
        action = json_body['action']
        pr_number = json_body['number']
        full_name = json_body['repo']['full_name']

        if action == 'open' or action == 'synchronize':
            api_handler = Githandler()
            commits = api_handler.get_commits_sha(pr_number, full_name)
            print commits

        self.write("Success!")

if __name__ == "__main__":
    application = tornado.web.Application([
        (r"/", MainHandler),
    ])
    application.listen(8080)
    tornado.ioloop.IOLoop.current().start()
